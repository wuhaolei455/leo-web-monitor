<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leo Error Monitor - 基础使用示例</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .demo-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #errorLog {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
        }
        .error-entry {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-left: 4px solid #dc3545;
            border-radius: 2px;
        }
        .error-time {
            color: #6c757d;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <h1>Leo Web Monitor - 基础使用示例</h1>
    
    <div class="demo-section">
        <h3>1. 基础初始化</h3>
        <p>SDK已自动初始化并开始监控错误</p>
        <pre><code>const monitor = new LeoWebMonitor({
  debug: true,
  autoCapture: true,
  maxErrorQueueSize: 50,
  blankScreen: {
    enabled: true,
    delay: 1000,
    sampleCount: 10,
    threshold: 0.8
  }
});</code></pre>
    </div>

    <div class="demo-section">
        <h3>2. 测试不同类型的错误</h3>
        
        <button onclick="triggerJSError()">触发 JavaScript 错误</button>
        <button onclick="triggerPromiseError()">触发 Promise 错误</button>
        <button onclick="triggerResourceError()">触发资源加载错误</button>
        <button onclick="triggerCustomError()">触发自定义错误</button>
        
        <br><br>
        
        <button onclick="showErrorStats()">显示错误统计</button>
        <button onclick="getErrorList()">获取错误列表</button>
        <button onclick="clearErrors()">清空错误</button>
    </div>

    <div class="demo-section">
        <h3>3. 白屏检测功能</h3>
        <p>白屏检测可以帮助发现页面渲染异常的情况</p>
        
        <button onclick="checkBlankScreen()">手动检测白屏</button>
        <button onclick="getBlankScreenStatus()">获取检测状态</button>
        <button onclick="simulateBlankScreen()">模拟白屏情况</button>
        
        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
            <strong>白屏检测说明:</strong>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>SDK会在页面加载后自动进行白屏检测</li>
                <li>默认延迟1秒后开始检测，采样10个随机点</li>
                <li>当80%以上的采样点为空白时，判定为白屏</li>
                <li>检测到白屏会自动上报错误信息</li>
            </ul>
        </div>
    </div>

    <div class="demo-section">
        <h3>4. 错误日志</h3>
        <div id="errorLog"></div>
    </div>

    <!-- 引入SDK -->
    <script src="../dist/index.umd.js"></script>
    
    <script>
        // 初始化监控器
        const monitor = new LeoWebMonitor.default({
            debug: true,
            autoCapture: true,
            maxErrorQueueSize: 50,
            // 白屏检测配置
            blankScreen: {
                enabled: true,
                delay: 1000,
                sampleCount: 10,
                threshold: 0.8
            },
            onError: function(errorInfo) {
                displayError(errorInfo);
            }
        });

        // 启动监控
        monitor.start();

        // 错误显示函数
        function displayError(errorInfo) {
            const errorLog = document.getElementById('errorLog');
            const errorEntry = document.createElement('div');
            errorEntry.className = 'error-entry';
            
            const time = new Date(errorInfo.timestamp).toLocaleTimeString();
            errorEntry.innerHTML = `
                <div class="error-time">[${time}] ${errorInfo.type}</div>
                <div><strong>消息:</strong> ${errorInfo.message}</div>
                ${errorInfo.filename ? `<div><strong>文件:</strong> ${errorInfo.filename}:${errorInfo.lineno || 0}:${errorInfo.colno || 0}</div>` : ''}
                ${errorInfo.stack ? `<div><strong>堆栈:</strong><br><pre style="margin: 5px 0; white-space: pre-wrap;">${errorInfo.stack}</pre></div>` : ''}
            `;
            
            errorLog.insertBefore(errorEntry, errorLog.firstChild);
            
            // 限制显示的错误数量
            while (errorLog.children.length > 20) {
                errorLog.removeChild(errorLog.lastChild);
            }
        }

        // 测试函数
        function triggerJSError() {
            // 故意触发一个引用错误
            undefinedVariable.someMethod();
        }

        function triggerPromiseError() {
            // 触发一个未处理的Promise拒绝
            new Promise((resolve, reject) => {
                reject(new Error('这是一个未处理的Promise错误'));
            });
        }

        function triggerResourceError() {
            // 尝试加载一个不存在的图片
            const img = new Image();
            img.src = 'https://example.com/non-existent-image.jpg';
            document.body.appendChild(img);
        }

        function triggerCustomError() {
            // 手动捕获一个自定义错误
            monitor.captureError('这是一个手动捕获的自定义错误', {
                userId: '12345',
                action: 'button_click',
                component: 'demo_page'
            });
        }

        function showErrorStats() {
            const stats = monitor.getErrorStats();
            alert(`错误统计:\n总错误数: ${stats.totalErrors}\n队列大小: ${stats.queueSize}\n待上报: ${stats.pendingReports}`);
        }

        function getErrorList() {
            const errors = monitor.getErrors();
            console.log('所有错误:', errors);
            alert(`已捕获 ${errors.length} 个错误，详情请查看控制台`);
        }

        // 白屏检测相关功能
        async function checkBlankScreen() {
            const isBlank = await monitor.checkBlankScreen();
            alert(`白屏检测结果: ${isBlank ? '检测到白屏' : '页面正常'}`);
        }

        function getBlankScreenStatus() {
            const status = monitor.getBlankScreenDetectorStatus();
            if (status) {
                alert(`白屏检测状态:\n启用: ${status.enabled ? '是' : '否'}\n检测中: ${status.isChecking ? '是' : '否'}`);
            } else {
                alert('白屏检测器未初始化');
            }
        }

        function simulateBlankScreen() {
            // 模拟白屏情况
            document.body.style.backgroundColor = 'white';
            document.body.innerHTML = '<div style="width:100%;height:100vh;background:white;"></div>';
            setTimeout(() => {
                alert('已模拟白屏情况，3秒后将恢复页面');
                setTimeout(() => {
                    location.reload();
                }, 3000);
            }, 1000);
        }

        function clearErrors() {
            monitor.clearErrors();
            document.getElementById('errorLog').innerHTML = '';
            alert('错误已清空');
        }

        // 页面加载完成提示
        window.addEventListener('load', function() {
            displayError({
                type: 'info',
                message: '页面加载完成，错误监控已启动',
                timestamp: Date.now()
            });
        });
    </script>
</body>
</html>
